
# 1. إيقاف وحذف الحاويات مع الـ Volumes (سيحذف البيانات القديمة)
sudo docker-compose down -v

# 2. حذف ملفات الميجريشن القديمة لضمان عدم وجود تعارض
sudo rm library/migrations/000*.py

# 3. بناء الحاوية من جديد
sudo docker-compose up -d --build

# 4. إنشاء ملفات قاعدة البيانات الجديدة
sudo docker exec -it rsu_project-web-1 python manage.py makemigrations library
sudo docker exec -it rsu_project-web-1 python manage.py migrate

# 5. إنشاء مستخدم الـ Root الجديد (تأكد من تسميته Zero)
sudo docker exec -it rsu_project-web-1 python manage.py createsuperuser





curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb


sudo dpkg -i cloudflared.deb


cloudflared --version

cloudflared tunnel --url http://localhost:8000

sudo apt update
sudo apt install screen -y

screen -S mytunnel

الخروج مع تركها تعمل (Detach):
اضغط على الأزرار التالية في الكيبورد بالترتيب:
​اضغط Ctrl + A
​ثم ارفع يدك واضغط حرف D
​


screen -r mytunnel



  https://tries-name-women-performer.trycloudflare.com 




  tunnel:
    image: cloudflare/cloudflared:latest
    command: tunnel --url http://web:8000  # استبدل web باسم خدمة الموقع في ملفك
    restart: unless-stopped
    depends_on:
      - web # تأكد أن هذا يطابق اسم خدمة الباك-إند أو الفرونت-إند لديك





ملف .env

DEBUG=True
SECRET_KEY='django-insecure-put-your-long-secret-key-here'
# إعدادات قاعدة البيانات
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=db
DB_PORT=5432







@Codebase
Act as a Senior Full Stack Engineer and DevOps Specialist. I need you to perform a comprehensive review and refactoring of this entire project.

Please execute the following step-by-step plan:

1. **Codebase Health Check & Fixes:**
   - Scan all project files for logical conflicts, syntax errors, or incomplete code blocks.
   - Identify any missing files that are referenced but not created, and generate them with appropriate boilerplate code.
   - Refactor any code that causes circular imports or structure conflicts.

2. **Feature Enhancement (Materials Management):**
   - Locate the section where "Materials" (items/files) are listed.
   - Add functional "Download" buttons and "Delete" buttons for each item.
   - Ensure the backend logic supports these actions (delete route and download route).

3. **Bug Fix (Login System):**
   - Review the Login page logic (frontend and backend).
   - Identify why the login might be failing (check authentication flow, session management, or token handling) and fix it.

4. **Docker & Dependencies Synchronization:**
   - Review the `docker-compose.yml` and `Dockerfile`.
   - specific check: Cross-reference `requirements.txt` (or package.json) with the actual imports used in the code. Ensure ALL dependencies are listed and versions are compatible.
   - Ensure the Docker setup is self-contained and ready to build without errors.

5. **Deployment Guide:**
   - After fixing the code, create a new file named `DEPLOYMENT.md`.
   - Write a detailed guide in this file for deploying this specific Dockerized project on an **Ubuntu 22.04 LTS** server.
   - The guide must include steps for:
     - Installing Docker & Docker Compose on Ubuntu.
     - Cloning the repo and setting environment variables.
     - Commands to build and run the containers.
     - How to expose the application to the internet (setup basic Nginx reverse proxy instructions if needed) and how to access it locally.

**Output:**
- Apply the code fixes directly to the files.
- Explain briefly what you fixed.
- Create the `DEPLOYMENT.md` file at the root.











انشاء حساب الroot 



sudo docker-compose exec web python manage.py createsuperuser


سيطلب منك النظام:
​Username: (اكتب مثلاً admin واضغط Enter).
​Email: (يمكنك تركه فارغاً أو كتابة إيميلك).
​Password: (اكتب كلمة مرور قوية، لن تظهر الحروف أثناء الكتابة وهذا طبيعي لدواعي الأمان، اكتبها واضغط Enter).
​كرر كلمة المرور.
​بعدها، اذهب للمتصفح واكتب: http://192.168.111.129:8080/admin (أو استخدم IP الويندوز إذا كنت من جهاز آخر). ستظهر لك لوحة تحكم Django الجاهزة!



اعدادات ملف الضبط

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'library',  # <--- أضف هذا السطر هنا
]





# --- إعدادات اللغة والتوقيت ---
LANGUAGE_CODE = 'ar'
TIME_ZONE = 'Africa/Khartoum' 
USE_I18N = True
USE_TZ = True

# --- تعريف نموذج المستخدم المخصص ---
AUTH_USER_MODEL = 'library.User'

# --- إعدادات الملفات (150 ميقا كحد أقصى) ---
DATA_UPLOAD_MAX_MEMORY_SIZE = 157286400  # 150 MB
FILE_UPLOAD_MAX_MEMORY_SIZE = 157286400  # 150 MB

# --- إعدادات الجلسة (للزوار 30 دقيقة) ---
SESSION_COOKIE_AGE = 1800  # 30 minutes
SESSION_EXPIRE_AT_BROWSER_CLOSE = True

# --- إعدادات تسجيل الدخول ---
LOGIN_URL = 'login'
LOGIN_REDIRECT_URL = 'home'
LOGOUT_REDIRECT_URL = 'login'

# تحذير: هذا سيمسح البيانات القديمة وهو ضروري في هذه المرحلة
sudo docker-compose exec db psql -U postgres -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"






sudo docker-compose exec web python manage.py makemigrations library




sudo docker-compose exec web python manage.py migrate




sudo docker-compose exec web python manage.py createsuperuser











@login_required
def add_user_view(request):
    # مسموح فقط للـ Root (Zero) بإضافة مستخدمين
    if request.user.user_type != 'ROOT':
        return redirect('home')
        
    if request.method == 'POST':
        full_name = request.POST.get('full_name')
        username = request.POST.get('username') # الرقم الجامعي
        password = request.POST.get('password')
        user_type = request.POST.get('user_type') # STUDENT أو ADMIN
        
        if User.objects.filter(username=username).exists():
            messages.error(request, 'هذا الرقم الجامعي مسجل مسبقاً!')
        else:
            new_user = User.objects.create_user(
                username=username, 
                password=password,
                full_name=full_name,
                user_type=user_type
            )
            log_activity(request.user, f"إضافة مستخدم جديد: {username}", request)
            messages.success(request, f'تم إضافة {full_name} بنجاح')
            return redirect('root_dashboard')
            
    return render(request, 'library/add_user.html')






<a href="{% url 'add_user' %}" class="btn btn-primary py-3 mb-2 shadow-sm"><i class="fas fa-user-plus me-2"></i> إضافة طالب أو دكتور جديد</a>







    path('add-user/', views.add_user_view, name='add_user'),
