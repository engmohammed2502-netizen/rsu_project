from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponse, Http404, FileResponse
# >>> تم تعديل الموديلات لتشمل GuestLog و ForumPost الجديد >>>
from .models import User, Course, CourseFile, ForumPost, ActivityLog, GuestLog, Department
import os

# --- 1. دوال المساعدة (Helpers) ---
def log_activity(user, action, request):
    ip = request.META.get('REMOTE_ADDR')
    ActivityLog.objects.create(user=user, action=action, ip_address=ip)

def is_guest(request):
    return request.session.get('is_guest', False)

# --- 2. المصادقة (Auth) ---
def login_view(request):
    if request.user.is_authenticated:
        return redirect('home')
        
    if request.method == 'POST':
        user_id = request.POST.get('username')
        password = request.POST.get('password')
        
        user = authenticate(request, username=user_id, password=password)
        
        if user is not None:
            # >>> فحص التجميد المطور >>>
            if user.is_frozen:
                messages.error(request, 'عذراً، تم تجميد حسابك. الرجاء مراجعة الإدارة.')
                return redirect('login')
                
            login(request, user)
            log_activity(user, "تسجيل دخول", request)
            
            if user.user_type == 'ROOT':
                return redirect('root_dashboard')
            return redirect('home')
        else:
            messages.error(request, 'بيانات الدخول غير صحيحة')
            
    return render(request, 'library/login.html')

def guest_login(request):
    if request.method == 'POST':
        name = request.POST.get('guest_name')
        if name:
            # >>> تسجيل الزائر في قاعدة البيانات (جديد) >>>
            GuestLog.objects.create(name=name)
            
            request.session['is_guest'] = True
            request.session['guest_name'] = name
            request.session.set_expiry(1800) # 30 دقيقة
            return redirect('home')
    return render(request, 'library/guest_login.html')

def logout_view(request):
    if request.user.is_authenticated:
        log_activity(request.user, "تسجيل خروج", request)
    logout(request)
    request.session.flush()
    return redirect('login')

# --- 3. الصفحات الرئيسية ---
def home(request):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
    
    # >>> جلب الأقسام من قاعدة البيانات بدلاً من القائمة الثابتة >>>
    departments = Department.objects.all()
    
    context = {
        'departments': departments,
        'user_name': request.user.full_name if request.user.is_authenticated else request.session.get('guest_name', "زائر")
    }
    return render(request, 'library/home.html', context)

def department_view(request, dept_id): # تم تغيير dept_code لـ dept_id
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
    
    dept = get_object_or_404(Department, id=dept_id)
    # السمسترات ثابتة كما في كودك
    SEMESTERS = range(1, 11) 
    context = {'dept': dept, 'semesters': SEMESTERS}
    return render(request, 'library/department.html', context)

def semester_view(request, dept_id, sem_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    dept = get_object_or_404(Department, id=dept_id)
    courses = Course.objects.filter(department=dept, semester=sem_id)
    
    context = {
        'courses': courses,
        'dept': dept,
        'semester_name': f"السمستر {sem_id}"
    }
    return render(request, 'library/semester.html', context)

def course_detail(request, course_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    course = get_object_or_404(Course, pk=course_id)
    # >>> الترتيب من كودك القديم >>>
    files = course.files.all().order_by('-uploaded_at')
    # >>> التعليقات بنظام الردود (المنتدى المطور) >>>
    comments = course.comments.filter(parent=None).order_by('-created_at')
    
    # رفع الملفات (للدكاترة والروت) - كودك الأصلي
    if request.method == 'POST' and 'upload_file' in request.POST:
        if request.user.is_authenticated and request.user.user_type in ['ADMIN', 'ROOT']:
            CourseFile.objects.create(
                course=course,
                title=request.POST.get('title'),
                file=request.FILES['file']
            )
            messages.success(request, 'تم رفع الملف بنجاح')
            
    context = {
        'course': course, 
        'files': files, 
        'comments': comments,
        'user_name': request.user.full_name if request.user.is_authenticated else request.session.get('guest_name')
    }
    return render(request, 'library/course_detail.html', context)

# >>> دالة إضافة تعليق أو رد (جديد) >>>
def add_comment(request, course_id):
    if request.method == 'POST':
        course = get_object_or_404(Course, id=course_id)
        content = request.POST.get('content')
        parent_id = request.POST.get('parent_id')
        parent_obj = ForumPost.objects.get(id=parent_id) if parent_id else None
        
        user = request.user if request.user.is_authenticated else None
        guest_name = request.session.get('guest_name') if not request.user.is_authenticated else None

        if content:
            ForumPost.objects.create(
                course=course, 
                user=user, 
                guest_name=guest_name, 
                content=content, 
                parent=parent_obj
            )
    return redirect('course_detail', course_id=course_id)

# --- 4. لوحة تحكم الروت (Zero) ---
@login_required
def root_dashboard(request):
    if request.user.user_type != 'ROOT':
        return redirect('home')
        
    stats = {
        'students_count': User.objects.filter(user_type='STUDENT').count(),
        'professors_count': User.objects.filter(user_type='ADMIN').count(),
        'files_count': CourseFile.objects.count(),
        'active_now': ActivityLog.objects.filter(timestamp__gte=timezone.now()-timezone.timedelta(minutes=5)).count(),
    }
    logs = ActivityLog.objects.all().order_by('-timestamp')[:20]
    return render(request, 'library/dashboard.html', {'stats': stats, 'logs': logs})

# --- 5. تحميل الملفات (تم تطويرها لضمان التنزيل في دوكر) ---
def download_file(request, file_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    file_obj = get_object_or_404(CourseFile, pk=file_id)
    file_path = file_obj.file.path
    if os.path.exists(file_path):
        return FileResponse(open(file_path, 'rb'), as_attachment=True)
    raise Http404

@login_required
def delete_file(request, file_id):
    file_obj = get_object_or_404(CourseFile, pk=file_id)
    if request.user.user_type == 'ROOT': # صلاحية الحذف للروت
        file_obj.delete()
        messages.success(request, 'تم حذف الملف')
    return redirect(request.META.get('HTTP_REFERER'))

@login_required
def add_user_view(request):
    if request.user.user_type != 'ROOT':
        return redirect('home')
        
    if request.method == 'POST':
        full_name = request.POST.get('full_name')
        username = request.POST.get('username')
        password = request.POST.get('password')
        user_type = request.POST.get('user_type')
        
        if User.objects.filter(username=username).exists():
            messages.error(request, 'هذا المستخدم مسجل مسبقاً!')
        else:
            User.objects.create_user(
                username=username, 
                password=password,
                full_name=full_name,
                user_type=user_type
            )
            log_activity(request.user, f"إضافة مستخدم جديد: {username}", request)
            messages.success(request, f'تم إضافة {full_name} بنجاح')
            return redirect('root_dashboard')
            
    return render(request, 'library/add_user.html')
