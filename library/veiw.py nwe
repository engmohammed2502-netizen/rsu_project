from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.utils import timezone
from django.http import HttpResponse, Http404, FileResponse
from .models import User, Course, CourseFile, ForumPost, GuestLog, ActivityLog, DEPARTMENTS, SEMESTERS
import os

# --- 1. دوال المساعدة (Helpers) ---
def log_activity(user, action, request):
    ip = request.META.get('REMOTE_ADDR')
    ActivityLog.objects.create(user=user, action=action, ip_address=ip)

def is_guest(request):
    return request.session.get('is_guest', False)

# --- 2. المصادقة (Auth) ---
def login_view(request):
    if request.user.is_authenticated:
        return redirect('home')
        
    if request.method == 'POST':
        user_id = request.POST.get('username')
        password = request.POST.get('password')
        
        user = authenticate(request, username=user_id, password=password)
        
        if user is not None:
            # --- مهمة: تجميد الحسابات ---
            if user.is_frozen:
                # عرض الرسالة التي طلبتها في حال تجميد الحساب [cite: 2026-01-17]
                messages.error(request, 'عذراً، حسابك مجمد. يرجى التواصل مع الإدارة.')
                return render(request, 'library/login.html')
                
            login(request, user)
            log_activity(user, "تسجيل دخول", request)
            
            if user.user_type == 'ROOT':
                return redirect('root_dashboard')
            return redirect('home')
        else:
            messages.error(request, 'بيانات الدخول غير صحيحة')
            
    return render(request, 'library/login.html')

def guest_login(request):
    if request.method == 'POST':
        name = request.POST.get('guest_name')
        if name:
            # --- مهمة: نظام الزوار وسجل الدخول ---
            # تسجيل اسم الزائر في قاعدة البيانات عند الدخول [cite: 2026-01-17]
            GuestLog.objects.create(name=name)
            
            request.session['is_guest'] = True
            request.session['guest_name'] = name
            request.session.set_expiry(1800) 
            return redirect('home')
    return render(request, 'library/guest_login.html') # صفحة لطلب اسم الزائر

def logout_view(request):
    if request.user.is_authenticated:
        log_activity(request.user, "تسجيل خروج", request)
    logout(request)
    request.session.flush()
    return redirect('login')

# --- 3. الصفحات الرئيسية ---
def home(request):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    context = {
        'departments': DEPARTMENTS,
        'user_name': request.session.get('guest_name', request.user.full_name if request.user.is_authenticated else "زائر")
    }
    return render(request, 'library/home.html', context)

def department_view(request, dept_code):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
    
    dept_name = dict(DEPARTMENTS).get(dept_code)
    context = {'dept_code': dept_code, 'dept_name': dept_name, 'semesters': SEMESTERS}
    return render(request, 'library/department.html', context)

def semester_view(request, dept_code, sem_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    courses = Course.objects.filter(department=dept_code, semester=sem_id)
    dept_name = dict(DEPARTMENTS).get(dept_code)
    
    context = {
        'courses': courses,
        'dept_name': dept_name,
        'semester_name': f"السمستر {sem_id}"
    }
    return render(request, 'library/semester.html', context)

# --- مهمة: تفعيل المنتدى (تعليقات وردود) ---
def course_detail(request, course_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    course = get_object_or_404(Course, pk=course_id)
    files = course.files.all().order_by('-upload_date')
    
    # جلب التعليقات الرئيسية فقط (التي ليس لها أب) لترتيب الردود تحتها [cite: 2026-01-17]
    comments = course.comments.filter(parent=None).order_by('-created_at')
    
    # معالجة رفع الملفات (للدكاترة والروت)
    if request.method == 'POST' and 'upload_file' in request.POST:
        if request.user.is_authenticated and request.user.user_type in ['ADMIN', 'ROOT']:
            new_file = CourseFile(
                course=course,
                title=request.POST.get('title'),
                file_type=request.POST.get('file_type'),
                file=request.FILES['file'],
                uploaded_by=request.user
            )
            new_file.save()
            messages.success(request, 'تم رفع الملف بنجاح')
            return redirect('course_detail', course_id=course.id)
            
    context = {
        'course': course, 
        'files': files, 
        'comments': comments,
        'user_name': request.session.get('guest_name', request.user.full_name if request.user.is_authenticated else "زائر")
    }
    return render(request, 'library/course_detail.html', context)

# دالة إضافة التعليقات والردود للمنتدى
def add_comment(request, course_id):
    if request.method == 'POST':
        course = get_object_or_404(Course, id=course_id)
        content = request.POST.get('content')
        parent_id = request.POST.get('parent_id')
        
        parent_obj = None
        if parent_id:
            parent_obj = ForumPost.objects.get(id=parent_id)

        # إنشاء التعليق سواء كان لعضو أو ضيف [cite: 2026-01-17]
        ForumPost.objects.create(
            course=course,
            user=request.user if request.user.is_authenticated else None,
            guest_name=request.session.get('guest_name') if not request.user.is_authenticated else None,
            content=content,
            parent=parent_obj
        )
    return redirect('course_detail', course_id=course_id)

# --- 4. لوحة تحكم الروت (Zero) ---
@login_required
def root_dashboard(request):
    if request.user.user_type != 'ROOT':
        return redirect('home')
        
    stats = {
        'students_count': User.objects.filter(user_type='STUDENT').count(),
        'professors_count': User.objects.filter(user_type='ADMIN').count(),
        'files_count': CourseFile.objects.count(),
        'active_now': ActivityLog.objects.filter(timestamp__gte=timezone.now()-timezone.timedelta(minutes=5)).count(),
        'guest_logs': GuestLog.objects.all().order_by('-entry_time')[:10] # عرض آخر الضيوف
    }
    
    logs = ActivityLog.objects.all().order_by('-timestamp')[:20]
    return render(request, 'library/dashboard.html', {'stats': stats, 'logs': logs})

# --- 5. مهمة: إصلاح تحميل الملفات ---
def download_file(request, file_id):
    if not request.user.is_authenticated and not is_guest(request):
        return redirect('login')
        
    file_obj = get_object_or_404(CourseFile, pk=file_id)
    # استخدام FileResponse لضمان التحميل الصحيح للملفات الكبيرة [cite: 2026-01-20]
    try:
        response = FileResponse(open(file_obj.file.path, 'rb'), as_attachment=True)
        return response
    except FileNotFoundError:
        raise Http404("الملف غير موجود على السيرفر")

@login_required
def delete_file(request, file_id):
    file_obj = get_object_or_404(CourseFile, pk=file_id)
    if request.user.user_type == 'ROOT' or request.user == file_obj.uploaded_by:
        file_obj.delete()
        messages.success(request, 'تم حذف الملف')
    return redirect(request.META.get('HTTP_REFERER'))

@login_required
def add_user_view(request):
    if request.user.user_type != 'ROOT':
        return redirect('home')
        
    if request.method == 'POST':
        full_name = request.POST.get('full_name')
        username = request.POST.get('username')
        password = request.POST.get('password')
        user_type = request.POST.get('user_type')
        
        if User.objects.filter(username=username).exists():
            messages.error(request, 'هذا الرقم الجامعي مسجل مسبقاً!')
        else:
            User.objects.create_user(username=username, password=password, full_name=full_name, user_type=user_type)
            messages.success(request, f'تم إضافة {full_name} بنجاح')
            return redirect('root_dashboard')
            
    return render(request, 'library/add_user.html')
